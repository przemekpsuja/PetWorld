@page "/historia"
@rendermode InteractiveServer
@implements IDisposable
@using PetWorld.Application.Contracts
@using PetWorld.Domain.Entities
@inject IChatHistoryService ChatHistoryService

<PageTitle>Historia - PetWorld</PageTitle>

<ErrorBoundary>
    <ChildContent>
        <div class="container-fluid py-4 position-relative">
            <!-- Decorative Paws -->
            <div class="paw-decoration paw-1"></div>
            <div class="paw-decoration paw-2"></div>
            <div class="paw-decoration paw-3"></div>

            <!-- Hero Section -->
            <div class="hero-section">
                <h1 class="hero-title"> Historia rozm贸w</h1>
            </div>

            @if (chatHistories == null)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">adowanie...</span>
            </div>
        </div>
    }
    else if (!chatHistories.Any())
    {
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="empty-state">
                    <i class="bi bi-chat-dots"></i>
                    <h4 class="mb-2">Brak historii rozm贸w</h4>
                    <p class="mb-0">Rozpocznij konwersacj <a href="/" class="text-primary fw-bold">na stronie g贸wnej</a>!</p>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="glass-card">
                    <div class="table-responsive">
                        <table class="table history-table mb-0">
                            <thead>
                                <tr>
                                    <th scope="col">Data</th>
                                    <th scope="col">Pytanie</th>
                                    <th scope="col">Odpowied藕</th>
                                    <th scope="col" class="text-center">Iteracje</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var chat in chatHistories)
                                {
                                    <tr>
                                        <td class="text-nowrap">@chat.Date.ToString("dd.MM.yyyy HH:mm")</td>
                                        <td>@chat.Question</td>
                                        <td>@chat.Answer</td>
                                        <td class="text-center">
                                            <span class="badge bg-primary">@chat.IterationCount</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }
        </div>
    </ChildContent>
    <ErrorContent>
        <div class="container-fluid py-4">
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Wystpi nieoczekiwany bd</h4>
                <p>Przepraszamy, nie udao si zaadowa historii rozm贸w. Spr贸buj odwie偶y stron.</p>
                <hr>
                <p class="mb-0">Jeli problem bdzie si powtarza, skontaktuj si z administratorem.</p>
            </div>
        </div>
    </ErrorContent>
</ErrorBoundary>

@code {
    private List<ChatHistory>? chatHistories;
    private CancellationTokenSource? _cancellationTokenSource;

    protected override void OnInitialized()
    {
        _cancellationTokenSource = new CancellationTokenSource();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            chatHistories = await ChatHistoryService.GetAllAsync(_cancellationTokenSource!.Token);
        }
        catch (OperationCanceledException)
        {
            // Component was disposed before data loaded, this is expected
        }
    }

    public void Dispose()
    {
        _cancellationTokenSource?.Cancel();
        _cancellationTokenSource?.Dispose();
    }
}
