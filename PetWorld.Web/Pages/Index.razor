
@page "/"
@rendermode InteractiveServer
@implements IDisposable
@using PetWorld.Application.Contracts
@inject IChatService ChatService
@inject IChatHistoryService ChatHistoryService
@inject IJSRuntime JSRuntime
@inject ILogger<Index> Logger

<PageTitle>PetWorld - Tw√≥j sklep zoologiczny</PageTitle>

<ErrorBoundary>
    <ChildContent>
        <div class="container-fluid py-4 position-relative">
            <!-- Decorative Paws -->
            <div class="paw-decoration paw-1">üêæ</div>
            <div class="paw-decoration paw-2">üêæ</div>
            <div class="paw-decoration paw-3">üêæ</div>

            <!-- Hero Section -->
            <div class="hero-section">
                <h1 class="hero-title">üêæ Witaj w PetWorld!</h1>
                <p class="hero-subtitle">Zapytaj naszego asystenta AI o produkty dla Twojego pupila</p>
            </div>

            <!-- Question Form -->
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="glass-card p-4 p-md-5">
                <textarea
                    class="form-control form-control-lg chat-textarea"
                    rows="5"
                    placeholder="Np. Szukam karmy dla psa rasy golden retriever..."
                    @bind-value="userQuestion"
                    @bind-value:event="oninput"
                    @onkeydown="HandleKeyDown"
                    disabled="@isProcessing"></textarea>
            </div>
            <div class="button-container">
                <button
                    class="btn btn-primary btn-lg send-button"
                    @onclick="SendQuestion"
                    disabled="@isProcessing">
                    @if (isProcessing)
                    {
                        <span class="spinner-border spinner-border-sm spinner-custom me-2" role="status" aria-hidden="true"></span>
                        <span>Analizujƒô Twoje pytanie...</span>
                    }
                    else
                    {
                        <i class="bi bi-send-fill me-2"></i>
                        <span>Wy≈õlij pytanie</span>
                    }
                </button>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="row justify-content-center mt-4">
            <div class="col-12">
                <div class="alert error-alert alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Ups!</strong> @errorMessage
                    <button type="button" class="btn-close btn-close-white" @onclick="() => errorMessage = string.Empty"></button>
                </div>
            </div>
        </div>
    }

    <!-- Response Card -->
    @if (!string.IsNullOrEmpty(aiResponse))
    {
        <div class="row justify-content-center mt-5" id="response-section">
            <div class="col-12">
                <div class="card response-card">
                    <div class="response-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="response-title mb-0">
                                <i class="bi bi-lightbulb-fill me-2"></i>Rekomendacje dla Ciebie
                            </h5>
                            <span class="iteration-badge">
                                <i class="bi bi-arrow-repeat me-1"></i>Iteracje: @iterationCount
                            </span>
                        </div>
                    </div>
                    <div class="response-body">
                        @aiResponse
                    </div>
                </div>
            </div>
        </div>
    }
        </div>
    </ChildContent>
    <ErrorContent>
        <div class="container-fluid py-4">
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>WystƒÖpi≈Ç nieoczekiwany b≈ÇƒÖd</h4>
                <p>Przepraszamy, aplikacja napotka≈Ça problem. Spr√≥buj od≈õwie≈ºyƒá stronƒô.</p>
                <hr>
                <p class="mb-0">Je≈õli problem bƒôdzie siƒô powtarza≈Ç, skontaktuj siƒô z administratorem.</p>
            </div>
        </div>
    </ErrorContent>
</ErrorBoundary>

@code {
    private string userQuestion = string.Empty;
    private string aiResponse = string.Empty;
    private string errorMessage = string.Empty;
    private int iterationCount = 0;
    private bool isProcessing = false;
    private CancellationTokenSource? _cancellationTokenSource;

    protected override void OnInitialized()
    {
        _cancellationTokenSource = new CancellationTokenSource();
    }

    public void Dispose()
    {
        _cancellationTokenSource?.Cancel();
        _cancellationTokenSource?.Dispose();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey && !isProcessing)
        {
            await SendQuestion();
        }
    }

    private async Task SendQuestion()
    {
        Logger.LogDebug("Processing user question");

        if (!ValidateQuestion())
            return;

        Logger.LogInformation("Processing question with length: {QuestionLength}", userQuestion.Length);

        try
        {
            ResetUIState();
            isProcessing = true;

            var response = await GetAIResponseAsync(_cancellationTokenSource!.Token);
            await SaveChatHistoryAsync(response, _cancellationTokenSource!.Token);
            UpdateUIWithResponse(response);
            await ScrollToResponseAsync();
        }
        catch (OperationCanceledException)
        {
            Logger.LogInformation("Question processing was cancelled");
            errorMessage = "Operacja zosta≈Ça anulowana.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error processing user question");
            errorMessage = $"WystƒÖpi≈Ç b≈ÇƒÖd podczas przetwarzania zapytania: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            Logger.LogDebug("Question processing completed");
        }
    }

    private bool ValidateQuestion()
    {
        if (string.IsNullOrWhiteSpace(userQuestion))
        {
            Logger.LogDebug("Question validation failed: empty question");
            errorMessage = "Proszƒô wpisaƒá pytanie przed wys≈Çaniem.";
            return false;
        }
        return true;
    }

    private void ResetUIState()
    {
        errorMessage = string.Empty;
        aiResponse = string.Empty;
    }

    private async Task<ChatResponse> GetAIResponseAsync(CancellationToken cancellationToken)
    {
        Logger.LogDebug("Invoking ChatService for question processing");
        var response = await ChatService.GetResponseAsync(userQuestion, cancellationToken);

        Logger.LogInformation("Received AI response with {AnswerLength} characters after {IterationCount} iterations",
            response.Answer.Length, response.IterationCount);

        return response;
    }

    private async Task SaveChatHistoryAsync(ChatResponse response, CancellationToken cancellationToken)
    {
        await ChatHistoryService.SaveAsync(
            userQuestion,
            response.Answer,
            response.IterationCount,
            cancellationToken);

        Logger.LogDebug("Chat history saved to database");
    }

    private void UpdateUIWithResponse(ChatResponse response)
    {
        aiResponse = response.Answer;
        iterationCount = response.IterationCount;
        userQuestion = string.Empty;

        Logger.LogDebug("UI state updated with response");
    }

    private async Task ScrollToResponseAsync()
    {
        StateHasChanged();
        await Task.Delay(300); // Allow time for Blazor rendering

        try
        {
            await JSRuntime.InvokeVoidAsync("scrollToElement", "response-section");
            Logger.LogDebug("Auto-scroll to response section triggered");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to auto-scroll to response section");
        }
    }
}
